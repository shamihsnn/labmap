<!DOCTYPE html>
<html lang="en">
<head>
    <title>Report Vault</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body { 
            min-height: 100vh; 
            background: linear-gradient(120deg, #e3f0ff 0%, #f9f9f9 100%); 
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        * { box-sizing: border-box; /* Apply box-sizing to all elements */ }
        .vault-outer {
            min-height: 100vh;
            width: 100vw;
            margin: 0;
            border-radius: 0;
            background: linear-gradient(120deg, #fff 60%, #e3f0ff 100%);
            box-shadow: none;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        .vault-toolbar {
            display: flex;
            gap: 28px;
            margin: 0 auto 32px auto;
            justify-content: flex-start;
            flex-wrap: wrap;
            padding: 40px 0 0 0;
            width: 90%;
            max-width: 1200px;
            position: relative;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .vault-btn {
            background: #f7f7f7;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: 0.18s;
            box-shadow: 0 2px 8px #0001;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .vault-btn.active, .vault-btn:hover {
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            border-color: #1976d2;
            color: #fff;
        }
        .vault-btn i { font-size: 22px; }
        .vault-panel {
            background: #f9fbfd;
            border-radius: 18px;
            padding: 32px 24px;
            min-height: 260px;
            box-shadow: 0 1px 8px #0001;
            width: 90vw;
            max-width: 1200px;
            margin: 0 auto 32px auto;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
        }
        .search-sort-bar {
            display: flex;
            gap: 18px;
            align-items: center;
            margin-bottom: 18px;
        }
        .search-input {
            flex: 1;
            padding: 10px 16px;
            border-radius: 7px;
            border: 1.5px solid #b0b8c1;
            font-size: 16px;
            background: #fff;
            box-shadow: 0 1px 4px #0001;
        }
        .sort-dropdown {
            padding: 10px 16px;
            border-radius: 7px;
            border: 1.5px solid #b0b8c1;
            font-size: 16px;
            background: #fff;
            box-shadow: 0 1px 4px #0001;
        }
        .upload-area {
            border: 2px dashed #b0b8c1;
            border-radius: 10px;
            padding: 36px 0;
            text-align: center;
            background: #f5f8fa;
            margin-bottom: 24px;
        }
        .upload-area i { font-size: 44px; color: #1976d2; }
        .upload-area input[type=file] { display: none; }
        .upload-btn {
            margin-top: 16px;
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            border-radius: 7px;
            padding: 12px 28px;
            font-size: 17px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 2px 8px #1976d233;
        }
        .file-list { margin-top: 18px; width: 100%; }
        .file-card {
            background: #fff;
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 4px #0001;
            border: 1.5px solid #e0e0e0;
            width: 100%;
            box-sizing: border-box;
            transition: box-shadow 0.2s, border-color 0.2s;
            position: relative; /* For better responsive control */
            flex-wrap: nowrap; /* Prevent wrapping by default */
            gap: 10px; /* Add some spacing between elements */
        }
        .file-card:hover {
            box-shadow: 0 4px 16px #1976d233;
            border-color: #1976d2;
        }
        .file-preview {
            width: 48px; 
            height: 48px; 
            min-width: 48px; /* Prevent shrinking on small screens */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 18px;
        }
        .file-preview img { 
            max-width: 44px; 
            max-height: 44px; 
            border-radius: 6px; 
            object-fit: cover; /* Maintain aspect ratio */
        }
        .file-preview .fa-file { font-size: 36px; color: #b0b8c1; }
        .file-info { 
            flex: 1; 
            min-width: 0; /* Allow text truncation */
            overflow: hidden; /* Prevent overflow */
        }
        .file-name { 
            font-weight: 500; 
            color: #222; 
            word-break: break-word; /* Better than break-all for readability */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis for long names */
            max-width: 100%;
        }
        .file-meta { 
            font-size: 12px; 
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-actions { 
            display: flex; 
            align-items: center; 
            gap: 8px;
            flex-wrap: wrap; /* Allow wrapping on very small screens */
            justify-content: flex-end;
        }
        .file-actions button { background: none; border: none; color: #1976d2; font-size: 17px; margin-left: 0; cursor: pointer; transition: color 0.18s; }
        .file-actions button:hover { color: #c00; }
        .locked { margin-left: 8px; color: #c00; }
        .empty-state { text-align: center; color: #aaa; margin: 40px 0; }
        .category-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 22px; 
            margin: 18px 0 0 0;
            width: 100%; /* Ensure full width */
        }
        .category-card { 
            background: #f7fafd; 
            border-radius: 10px; 
            box-shadow: 0 1px 6px #0001; 
            padding: 22px 16px; 
            display: flex; 
            align-items: center; 
            gap: 14px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: 0.2s; 
            position: relative;
            overflow: hidden; /* Ensure content doesn't overflow */
        }
        .category-card.selected, .category-card:hover { border-color: #1976d2; background: #fff; }
        .category-icon { width: 38px; height: 38px; border-radius: 50%; background: #eaf2ff; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #1976d2; }
        .category-info { flex: 1; }
        .category-name { font-weight: 500; color: #222; font-size: 16px; }
        .category-count { background: #e0e0e0; color: #888; border-radius: 50px; padding: 2px 12px; font-size: 14px; font-weight: bold; margin-left: 8px; }
        .add-new { color: #1976d2; background: #eaf2ff; border: 2px dashed #1976d2; }
        .category-actions { display: flex; gap: 6px; margin-left: 8px; }
        .category-actions button { background: none; border: none; color: #1976d2; font-size: 15px; cursor: pointer; transition: color 0.18s; width: 24px; height: 24px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; }
        .category-actions button:hover { color: #fff; background: #1976d2; }
        .lock-list { margin-top: 18px; }
        .lock-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; background: #fff; border-radius: 7px; padding: 10px 14px; box-shadow: 0 1px 4px #0001; border: 1.5px solid #e0e0e0; }
        .lock-row input[type=password] { border: 1px solid #b0b8c1; border-radius: 5px; padding: 4px 8px; font-size: 15px; }
        .lock-row button { background: #1976d2; color: #fff; border: none; border-radius: 5px; padding: 5px 14px; font-size: 14px; cursor: pointer; margin-left: 6px; }
        .lock-row .remove-lock { background: #c00; }
        .notif { 
            position: fixed; 
            bottom: 24px; 
            right: 24px; 
            background: #1976d2; 
            color: #fff; 
            padding: 14px 28px; 
            border-radius: 8px; 
            font-size: 16px; 
            box-shadow: 0 2px 12px #0002; 
            z-index: 9999; 
            opacity: 0.97;
            max-width: calc(100% - 48px); /* Ensure it doesn't overflow screen */
            word-break: break-word; /* Allow word breaking for long messages */
        }
        
        @media (max-width: 480px) {
            .notif {
                bottom: 16px;
                right: 16px;
                padding: 12px 20px;
                font-size: 14px;
                max-width: calc(100% - 32px);
            }
        }
        /* Password Modal Styling */
        .modal-bg { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: #0007; 
            z-index: 1000; 
            align-items: center; 
            justify-content: center;
            padding: 15px; /* Add padding for small screens */
            overflow-y: auto; /* Allow scrolling on small screens */
        }
        .modal-bg.active { 
            display: flex; 
        }
        .modal { 
            background: #fff; 
            border-radius: 14px; 
            padding: 32px 28px 24px 28px; 
            min-width: 320px; 
            width: 100%; /* Responsive width */
            max-width: 500px; /* Maximum width */
            max-height: 90vh; /* Maximum height */
            overflow-y: auto; /* Allow scrolling if needed */
            box-shadow: 0 4px 32px #0003; 
            position: relative;
            margin: auto; /* Center on all screen sizes */
        }
        .modal-close { position: absolute; top: 14px; right: 16px; background: none; border: none; font-size: 22px; color: #888; cursor: pointer; transition: color 0.2s; }
        .modal-close:hover { color: #c00; }
        .modal label { 
            font-size: 17px; 
            color: #222; 
            font-weight: 500; 
            display: block; 
            margin-bottom: 10px;
        }
        .modal input[type=password] { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 18px; 
            border-radius: 6px; 
            border: 1.5px solid #b0b8c1; 
            font-size: 16px;
            box-sizing: border-box; /* Ensure padding doesn't affect width */
        }
        .modal-btn-row { 
            display: flex; 
            justify-content: flex-end; 
            gap: 12px;
            flex-wrap: wrap; /* Allow buttons to wrap on small screens */
        }
        @media (max-width: 480px) {
            .modal-btn-row {
                justify-content: stretch;
            }
            .modal-btn-row button {
                flex: 1;
                padding: 12px 15px;
                min-width: 0;
            }
        }
        .modal button { background: #1976d2; color: #fff; border: none; border-radius: 7px; padding: 9px 22px; font-size: 16px; cursor: pointer; font-weight: 500; }
        .modal .cancel { background: #aaa; }
        /* Enhanced responsiveness */
        @media (max-width: 1200px) {
            .vault-panel, .vault-toolbar { width: 95vw; }
            .category-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        }
        
        @media (max-width: 900px) {
            .vault-panel, .vault-toolbar { width: 98vw; }
            .category-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
            .vault-btn { padding: 12px 20px; font-size: 16px; }
            .vault-btn i { font-size: 18px; }
        }
        
        @media (max-width: 768px) {
            .vault-toolbar { flex-wrap: nowrap; overflow-x: auto; padding: 30px 0 0 0; justify-content: flex-start; }
            .vault-btn { flex: 0 0 auto; white-space: nowrap; }
            .vault-panel { border-radius: 12px; }
            .file-card { flex-wrap: wrap; padding: 12px; }
            .file-preview { margin-right: 12px; }
            .file-actions { width: 100%; justify-content: flex-end; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
            .modal { padding: 25px 20px 20px 20px; }
        }
        
        @media (max-width: 700px) {
            .vault-outer { padding: 0; }
            .vault-toolbar { flex-direction: row; gap: 10px; padding: 20px 0 0 0; }
            .vault-panel { padding: 16px 12px; margin-bottom: 16px; }
            .modal { min-width: 90vw; max-width: 95vw; }
            .search-sort-bar { flex-direction: column; gap: 12px; }
            .search-input, .sort-dropdown { width: 100%; box-sizing: border-box; }
            .upload-area { padding: 25px 10px; }
        }
        
        @media (max-width: 480px) {
            .vault-toolbar { padding: 15px 0 0 0; gap: 8px; }
            .vault-btn { padding: 8px 12px; font-size: 0; border-radius: 50px; width: 40px; height: 40px; justify-content: center; }
            .vault-btn i { font-size: 16px; margin: 0; }
            .file-card { padding: 10px; }
            .file-preview { width: 40px; height: 40px; min-width: 40px; margin-right: 10px; }
            .file-name { font-size: 14px; }
            .file-meta { font-size: 11px; }
            .file-actions button { font-size: 15px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: #f5f8fa; border-radius: 50%; margin: 0 2px; }
            .upload-btn { width: 100%; }
            .category-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .category-card { padding: 12px 10px; }
            .category-icon { width: 32px; height: 32px; min-width: 32px; font-size: 16px; }
            .category-name { font-size: 14px; }
            .lock-row { flex-wrap: wrap; }
            .lock-row input[type=password] { width: 100%; margin: 5px 0; }
            .lock-row button { margin: 5px 5px 5px 0; }
        }
        /* Share Modal Styling */
        .share-options { margin: 18px 0; }
        .share-row { display: flex; align-items: center; margin-bottom: 12px; }
        .share-row label { min-width: 140px; }
        .share-row select, .share-row input { 
            flex: 1; 
            padding: 8px; 
            border-radius: 6px; 
            border: 1.5px solid #b0b8c1; 
        }
        .share-link-result {
            margin: 18px 0;
            padding: 12px;
            background: #f5f8fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            word-break: break-all;
        }
        .share-history {
            margin-top: 24px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        .share-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            margin-bottom: 8px;
            border-radius: 6px;
        }
        .share-item-info {
            flex: 1;
        }
        .share-item-actions button {
            padding: 5px 12px;
            margin-left: 8px;
            font-size: 14px;
        }
        .share-item-expires {
            color: #c00;
            font-size: 13px;
        }
        .active-share {
            color: #388e3c;
            font-weight: 500;
        }
        .expired-share {
            color: #888;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
<div class="vault-outer">
    <div class="vault-toolbar">
        <button class="vault-btn active" id="btn-docs"><i class="fas fa-file-alt"></i> Upload Documents</button>
        <button class="vault-btn" id="btn-images"><i class="fas fa-image"></i> Upload Images</button>
        <button class="vault-btn" id="btn-lock"><i class="fas fa-lock"></i> Lock Files</button>
        <button class="vault-btn" id="btn-category"><i class="fas fa-folder"></i> Category Wise</button>
        <button class="vault-btn" id="btn-allfiles"><i class="fas fa-folder-open"></i> View Uploaded Files</button>
    </div>
    <div class="vault-panel" id="panel-docs">
        <div class="search-sort-bar">
            <input class="search-input" id="docsSearch" placeholder="Search documents...">
            <select class="sort-dropdown" id="docsSort">
                <option value="date-desc">Newest</option>
                <option value="date-asc">Oldest</option>
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="size-desc">Size (Largest)</option>
                <option value="size-asc">Size (Smallest)</option>
            </select>
        </div>
        <div class="upload-area" id="uploadDocsArea">
            <i class="fas fa-file-upload"></i>
            <div style="margin:10px 0;">Upload your documents (PDF, DOC, DOCX)</div>
            <input type="file" id="docsInput" multiple accept=".pdf,.doc,.docx">
            <button class="upload-btn" id="docsBrowseBtn">Browse Documents</button>
        </div>
        <div class="file-list" id="docsFileList"></div>
    </div>
    <div class="vault-panel" id="panel-images" style="display:none;">
        <div class="search-sort-bar">
            <input class="search-input" id="imagesSearch" placeholder="Search images...">
            <select class="sort-dropdown" id="imagesSort">
                <option value="date-desc">Newest</option>
                <option value="date-asc">Oldest</option>
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="size-desc">Size (Largest)</option>
                <option value="size-asc">Size (Smallest)</option>
            </select>
        </div>
        <div class="upload-area" id="uploadImagesArea">
            <i class="fas fa-image"></i>
            <div style="margin:10px 0;">Upload your images (JPG, PNG)</div>
            <input type="file" id="imagesInput" multiple accept=".jpg,.jpeg,.png">
            <button class="upload-btn" id="imagesBrowseBtn">Browse Images</button>
        </div>
        <div class="file-list" id="imagesFileList"></div>
    </div>
    <div class="vault-panel" id="panel-lock" style="display:none;">
        <div class="lock-list" id="lockList"></div>
    </div>
    <div class="vault-panel" id="panel-category" style="display:none;">
        <div class="category-grid" id="categoryGrid"></div>
        <div class="file-list" id="categoryFileList"></div>
    </div>
    <div class="vault-panel" id="panel-allfiles" style="display:none;">
        <div class="search-sort-bar">
            <input class="search-input" id="allFilesSearch" placeholder="Search all files...">
            <select class="sort-dropdown" id="allFilesSort">
                <option value="date-desc">Newest</option>
                <option value="date-asc">Oldest</option>
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="size-desc">Size (Largest)</option>
                <option value="size-asc">Size (Smallest)</option>
            </select>
        </div>
        <div class="file-list" id="allFilesList"></div>
    </div>
</div>
<!-- Password Modal -->
<div class="modal-bg" id="passwordModal">
    <div class="modal">
        <button class="modal-close" id="modalClose" title="Close">&times;</button>
        <label for="passwordInput">Set a password to lock this file <span style="color:#888;font-weight:400;">(optional)</span>:</label>
        <input type="password" id="passwordInput" placeholder="Password (leave blank for none)">
        <div class="modal-btn-row">
            <button class="cancel" id="modalCancel">Cancel</button>
            <button id="modalOk">OK</button>
        </div>
    </div>
</div>
<!-- Category Modal -->
<div class="modal-bg" id="categoryModal">
    <div class="modal">
        <button class="modal-close" id="categoryModalClose" title="Close">&times;</button>
        <h3>Assign to Category</h3>
        <div id="categoryModalGrid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:20px;"></div>
        <div class="modal-btn-row">
            <button class="cancel" id="categoryModalCancel">Cancel</button>
        </div>
    </div>
</div>
<!-- Category Upload Modal -->
<div class="modal-bg" id="categoryUploadModal">
    <div class="modal">
        <button class="modal-close" id="catUploadModalClose" title="Close">&times;</button>
        <h3>Upload Files to <span id="catUploadName"></span></h3>
        <div class="upload-area" id="catUploadArea" style="margin:15px 0;">
            <i class="fas fa-file-upload"></i>
            <div style="margin:10px 0;">Drag files here or click the button below</div>
            <input type="file" id="catUploadInput" multiple>
            <button class="upload-btn" id="catUploadBrowseBtn">Browse Files</button>
        </div>
        <div class="modal-btn-row">
            <button class="cancel" id="catUploadCancel">Cancel</button>
        </div>
    </div>
</div>
<!-- Share Modal -->
<div class="modal-bg" id="shareModal">
    <div class="modal">
        <button class="modal-close" id="shareModalClose" title="Close">&times;</button>
        <h3>Share File</h3>
        <div id="shareFileName" style="color:#555;margin-bottom:15px;font-style:italic;"></div>
        
        <div class="share-options">
            <div class="share-row">
                <label for="shareExpiry">Expires after:</label>
                <select id="shareExpiry">
                    <option value="1">1 day</option>
                    <option value="7" selected>7 days</option>
                    <option value="30">30 days</option>
                    <option value="90">90 days</option>
                    <option value="0">Never</option>
                </select>
            </div>
            <div class="share-row">
                <label for="sharePassword">Password protect:</label>
                <input type="password" id="sharePassword" placeholder="Optional password">
            </div>
        </div>
        
        <button class="upload-btn" style="width:100%" id="generateShareLink">
            <i class="fas fa-link"></i> Generate Share Link
        </button>
        
        <div class="share-link-result" id="shareLinkResult" style="display:none;"></div>
        
        <div class="modal-btn-row">
            <button class="cancel" id="shareModalCancel">Close</button>
            <button id="copyShareLinkBtn" style="display:none">Copy Link</button>
        </div>
        
        <div class="share-history" id="shareHistory" style="display:none;">
            <h4>Active Shares</h4>
            <div id="activeSharesList"></div>
        </div>
    </div>
</div>

<!-- Share Access Modal -->
<div class="modal-bg" id="shareAccessModal">
    <div class="modal">
        <button class="modal-close" id="shareAccessModalClose" title="Close">&times;</button>
        <h3>Access Shared File</h3>
        <div id="sharedFileInfo" style="margin:12px 0;"></div>
        
        <div id="sharePasswordPrompt" style="margin:20px 0;display:none;">
            <label for="accessSharePassword">This file is password protected:</label>
            <input type="password" id="accessSharePassword" placeholder="Enter password to access" style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1.5px solid #b0b8c1;">
        </div>
        
        <div class="modal-btn-row">
            <button class="cancel" id="shareAccessCancel">Cancel</button>
            <button id="shareAccessConfirm">Access File</button>
        </div>
    </div>
</div>

<div id="notif" class="notif" style="display:none;"></div>
<script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
<script>
const CATEGORIES = [
    { key: 'cardiology', label: 'Cardiology', icon: 'fa-heartbeat' },
    { key: 'neurology', label: 'Neurology', icon: 'fa-brain' },
    { key: 'orthopedics', label: 'Orthopedics', icon: 'fa-bone' },
    { key: 'pulmonology', label: 'Pulmonology', icon: 'fa-lungs' },
    { key: 'nephrology', label: 'Nephrology', icon: 'fa-kidneys' },
    { key: 'prescriptions', label: 'Prescriptions', icon: 'fa-tablets' },
    { key: 'lab', label: 'Lab Results', icon: 'fa-flask' },
    { key: 'add', label: 'Add New', icon: 'fa-plus', addNew: true }
];
let db;
let pendingFile = null, pendingType = null, pendingCategory = null;
let currentCategory = null;
let categoryFileType = 'all';
let allFilesType = 'all';
let selectedFiles = new Set();
let pendingShareFile = null;

// IndexedDB setup
async function initDB() {
    db = await idb.openDB('report-vault', 2, {
        upgrade(db, oldVersion, newVersion) {
            if (oldVersion < 1) {
                if (!db.objectStoreNames.contains('files')) {
                    db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                }
            }
            
            // Add shares store in version 2
            if (oldVersion < 2) {
                if (!db.objectStoreNames.contains('shares')) {
                    const shareStore = db.createObjectStore('shares', { keyPath: 'shareId' });
                    shareStore.createIndex('fileId', 'fileId');
                    shareStore.createIndex('expiresAt', 'expiresAt');
                }
            }
        }
    });
}

// Toolbar navigation
const panels = ['docs','images','lock','category','allfiles'];
function setPanel(panel) {
    panels.forEach(p => {
        document.getElementById('panel-'+p).style.display = (p===panel)?'block':'none';
        document.getElementById('btn-'+p).classList.toggle('active', p===panel);
    });
    if(panel==='category') renderCategories();
    if(panel==='lock') renderLockList();
    if(panel==='docs') renderDocsFiles();
    if(panel==='images') renderImagesFiles();
    if(panel==='allfiles') renderAllFiles();
}
document.getElementById('btn-docs').onclick = ()=>setPanel('docs');
document.getElementById('btn-images').onclick = ()=>setPanel('images');
document.getElementById('btn-lock').onclick = ()=>setPanel('lock');
document.getElementById('btn-category').onclick = ()=>setPanel('category');
document.getElementById('btn-allfiles').onclick = ()=>setPanel('allfiles');

// Upload Documents
function setupUploadDocs() {
    const browseBtn = document.getElementById('docsBrowseBtn');
    const fileInput = document.getElementById('docsInput');
    browseBtn.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
        if (e.target.files.length) {
            pendingFile = Array.from(e.target.files);
            pendingType = 'document';
            showPasswordModal();
        }
    };
    const uploadArea = document.getElementById('uploadDocsArea');
    uploadArea.ondragover = e => { e.preventDefault(); uploadArea.style.background='#eaf2ff'; };
    uploadArea.ondragleave = e => { e.preventDefault(); uploadArea.style.background=''; };
    uploadArea.ondrop = e => {
        e.preventDefault(); uploadArea.style.background='';
        if (e.dataTransfer.files.length) {
            pendingFile = Array.from(e.dataTransfer.files);
            pendingType = 'document';
            showPasswordModal();
        }
    };
}
// Upload Images
function setupUploadImages() {
    const browseBtn = document.getElementById('imagesBrowseBtn');
    const fileInput = document.getElementById('imagesInput');
    browseBtn.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
        if (e.target.files.length) {
            pendingFile = Array.from(e.target.files);
            pendingType = 'image';
            showPasswordModal();
        }
    };
    const uploadArea = document.getElementById('uploadImagesArea');
    uploadArea.ondragover = e => { e.preventDefault(); uploadArea.style.background='#eaf2ff'; };
    uploadArea.ondragleave = e => { e.preventDefault(); uploadArea.style.background=''; };
    uploadArea.ondrop = e => {
        e.preventDefault(); uploadArea.style.background='';
        if (e.dataTransfer.files.length) {
            pendingFile = Array.from(e.dataTransfer.files);
            pendingType = 'image';
            showPasswordModal();
        }
    };
}

function showPasswordModal() {
    document.getElementById('passwordModal').classList.add('active');
    document.getElementById('passwordInput').value = '';
}
document.getElementById('modalClose').onclick = function() {
    pendingFile = null; pendingType = null;
    document.getElementById('passwordModal').classList.remove('active');
};
document.getElementById('modalOk').onclick = async function() {
    const pwd = document.getElementById('passwordInput').value;
    if (pendingFile) {
        for (const file of pendingFile) {
            await saveFile(file, pwd, pendingType);
        }
    }
    pendingFile = null; pendingType = null;
    document.getElementById('passwordModal').classList.remove('active');
    renderDocsFiles();
    renderImagesFiles();
    renderLockList();
    renderCategories();
    renderAllFiles();
    showNotif('File(s) uploaded successfully!');
};
document.getElementById('modalCancel').onclick = function() {
    pendingFile = null; pendingType = null;
    document.getElementById('passwordModal').classList.remove('active');
};

async function saveFile(file, password, type) {
    const allFiles = await db.getAll('files');
    if (allFiles.some(f => f.name === file.name && f.size === file.size)) {
        if (!confirm('A file with this name and size already exists. Overwrite?')) return;
        const existing = allFiles.find(f => f.name === file.name && f.size === file.size);
        await db.delete('files', existing.id);
    }
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
            await db.add('files', {
                name: file.name,
                type: file.type,
                fileType: type,
                size: file.size,
                data: e.target.result,
                category: pendingCategory || currentCategory || null,
                password: password || null,
                date: new Date().toISOString()
            });
            resolve();
        };
        reader.readAsDataURL(file);
    });
}

// --- SEARCH & SORT ---
function sortFiles(files, sort) {
    switch(sort) {
        case 'date-desc': return files.sort((a,b)=>new Date(b.date)-new Date(a.date));
        case 'date-asc': return files.sort((a,b)=>new Date(a.date)-new Date(b.date));
        case 'name-asc': return files.sort((a,b)=>a.name.localeCompare(b.name));
        case 'name-desc': return files.sort((a,b)=>b.name.localeCompare(a.name));
        case 'size-desc': return files.sort((a,b)=>b.size-a.size);
        case 'size-asc': return files.sort((a,b)=>a.size-b.size);
        default: return files;
    }
}
function filterFiles(files, search) {
    if (!search) return files;
    return files.filter(f => f.name.toLowerCase().includes(search.toLowerCase()));
}
// --- FILE PREVIEW ---
function getFilePreview(file) {
    if (file.type.startsWith('image/')) {
        return `<img src="${file.data}" alt="${file.name}">`;
    }
    if (file.type === 'application/pdf') {
        return `<i class="fas fa-file-pdf" style="color:#d32f2f;"></i>`;
    }
    if (file.type.includes('word') || file.type.includes('doc')) {
        return `<i class="fas fa-file-word" style="color:#1976d2;"></i>`;
    }
    return `<i class="fas fa-file" style="color:#b0b8c1;"></i>`;
}
// --- FILE RENAME ---
window.renameFile = async function(id) {
    const file = await db.get('files', id);
    const newName = prompt('Rename file:', file.name);
    if (newName && newName.trim() && newName !== file.name) {
        file.name = newName.trim();
        await db.put('files', file);
        renderDocsFiles();
        renderImagesFiles();
        renderLockList();
        renderCategories();
        showNotif('File renamed.');
    }
};
// --- FILE LIST RENDER ---
function renderFileList(files, list) {
    if (!files.length) {
        list.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><br>No files found.</div>';
        return;
    }
    list.innerHTML = '';
    files.forEach(file => {
        const card = document.createElement('div');
        card.className = 'file-card';
        card.innerHTML = `<div class="file-preview">${getFilePreview(file)}</div>
            <div class="file-info">
                <span class="file-name">${file.name}</span>
                ${file.password ? '<i class="fas fa-lock locked" title="Locked"></i>' : ''}
                ${file.category ? `<span style="background:#e0e0e0;border-radius:50px;padding:2px 8px;font-size:11px;margin-left:8px">${getCategoryLabel(file.category)}</span>` : ''}
                <br>
                <span class="file-meta">${formatSize(file.size)} &middot; ${new Date(file.date).toLocaleDateString()}</span>
            </div>
            <div class="file-actions">
                <button title="View" onclick="viewFile(${file.id})"><i class="fas fa-eye"></i></button>
                <button title="Download" onclick="downloadFile(${file.id})"><i class="fas fa-download"></i></button>
                <button title="Share" onclick="showShareModal(${file.id})"><i class="fas fa-share-alt"></i></button>
                <button title="Rename" onclick="renameFile(${file.id})"><i class="fas fa-edit"></i></button>
                <button title="Assign Category" onclick="showCategoryModal(${file.id})"><i class="fas fa-folder"></i></button>
                <button title="Delete" onclick="deleteFile(${file.id})"><i class="fas fa-trash"></i></button>
            </div>`;
        list.appendChild(card);
    });
}
// --- DOCS PANEL ---
async function renderDocsFiles() {
    const files = await db.getAll('files');
    let filtered = files.filter(f => f.fileType === 'document');
    filtered = filterFiles(filtered, document.getElementById('docsSearch').value);
    filtered = sortFiles(filtered, document.getElementById('docsSort').value);
    renderFileList(filtered, document.getElementById('docsFileList'));
}
document.getElementById('docsSearch').oninput = renderDocsFiles;
document.getElementById('docsSort').onchange = renderDocsFiles;
// --- IMAGES PANEL ---
async function renderImagesFiles() {
    const files = await db.getAll('files');
    let filtered = files.filter(f => f.fileType === 'image');
    filtered = filterFiles(filtered, document.getElementById('imagesSearch').value);
    filtered = sortFiles(filtered, document.getElementById('imagesSort').value);
    renderFileList(filtered, document.getElementById('imagesFileList'));
}
document.getElementById('imagesSearch').oninput = renderImagesFiles;
document.getElementById('imagesSort').onchange = renderImagesFiles;
// --- CATEGORY WISE PANEL ---
function renderCategoryFiles(catKey) {
    db.getAll('files').then(files => {
        let filtered = files.filter(f => f.category === catKey);
        if (categoryFileType === 'document') filtered = filtered.filter(f => f.fileType === 'document');
        if (categoryFileType === 'image') filtered = filtered.filter(f => f.fileType === 'image');
        renderCategoryFileList(filtered, document.getElementById('categoryFileList'));
    });
}
function renderCategoryFileList(files, list) {
    list.innerHTML = '';
    
    // File type filter and upload button
    const filterBar = document.createElement('div');
    filterBar.style.display = 'flex';
    filterBar.style.gap = '10px';
    filterBar.style.marginBottom = '18px';
    filterBar.style.alignItems = 'center';
    
    filterBar.innerHTML = `
        <button class="upload-btn" style="padding:7px 18px;font-size:15px;${categoryFileType==='all'?'background:#1976d2;color:#fff;':''}" onclick="setCategoryFileType('all')">All</button>
        <button class="upload-btn" style="padding:7px 18px;font-size:15px;${categoryFileType==='document'?'background:#1976d2;color:#fff;':''}" onclick="setCategoryFileType('document')">Documents</button>
        <button class="upload-btn" style="padding:7px 18px;font-size:15px;${categoryFileType==='image'?'background:#1976d2;color:#fff;':''}" onclick="setCategoryFileType('image')">Images</button>
        <div style="flex:1"></div>
        <button class="upload-btn" style="display:flex;align-items:center;gap:8px;" onclick="showCategoryUploadModal('${currentCategory}', '${getCategoryLabel(currentCategory)}')"><i class="fas fa-upload"></i> Upload to ${getCategoryLabel(currentCategory)}</button>
    `;
    list.appendChild(filterBar);
    
    if (!files.length) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = '<i class="fas fa-folder-open"></i><br>No files in this category.<br><button class="upload-btn" style="margin-top:15px;" onclick="showCategoryUploadModal(\'' + currentCategory + '\', \'' + getCategoryLabel(currentCategory) + '\')">Upload Files</button>';
        list.appendChild(empty);
        return;
    }
    
    files.forEach(file => {
        const card = document.createElement('div');
        card.className = 'file-card';
        card.innerHTML = `
            <div class="file-preview">${getFilePreview(file)}</div>
            <div class="file-info">
                <span class="file-name">${file.name}</span>
                ${file.password ? '<i class="fas fa-lock locked" title="Locked"></i>' : '<i class="fas fa-unlock" style="color:#1976d2;margin-left:8px;" title="Unlocked"></i>'}<br>
                <span class="file-meta">${formatSize(file.size)} &middot; ${timeAgo(file.date)}</span>
            </div>
            <div class="file-actions">
                <button title="View" onclick="viewFile(${file.id})"><i class="fas fa-eye"></i></button>
                <button title="Download" onclick="downloadFile(${file.id})"><i class="fas fa-download"></i></button>
                <button title="Share" onclick="showShareModal(${file.id})"><i class="fas fa-share-alt"></i></button>
                <button title="Rename" onclick="renameFile(${file.id})"><i class="fas fa-edit"></i></button>
                <button title="${file.password ? 'Unlock' : 'Lock'}" onclick="toggleLockFile(${file.id})"><i class="fas ${file.password ? 'fa-unlock' : 'fa-lock'}"></i></button>
                <button title="Delete" onclick="deleteFile(${file.id})"><i class="fas fa-trash"></i></button>
            </div>`;
        list.appendChild(card);
    });
}
window.setCategoryFileType = function(type) {
    categoryFileType = type;
    renderCategoryFiles(currentCategory);
};
window.toggleLockFile = async function(id) {
    const file = await db.get('files', id);
    if (file.password) {
        if (!confirm('Remove password protection?')) return;
        file.password = null;
        await db.put('files', file);
        showNotif('File unlocked.');
    } else {
        const pwd = prompt('Set a password:');
        if (!pwd) return;
        file.password = pwd;
        await db.put('files', file);
        showNotif('File locked.');
    }
    renderCategoryFiles(currentCategory);
    renderDocsFiles();
    renderImagesFiles();
    renderLockList();
};
window.copyFileLink = async function(id) {
    const url = location.origin + location.pathname + '#file-' + id;
    try {
        await navigator.clipboard.writeText(url);
        showNotif('File link copied!');
    } catch {
        showNotif('Could not copy link.','error');
    }
};
function timeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now-date)/1000);
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff/60)+' min ago';
    if (diff < 86400) return Math.floor(diff/3600)+' hr ago';
    if (diff < 2592000) return Math.floor(diff/86400)+' days ago';
    return date.toLocaleDateString();
}
// ... existing code ...
window.deleteSelectedFiles = async function() {
    if (!selectedFiles.size) return;
    if (!confirm('Delete selected files?')) return;
    for (const id of selectedFiles) {
        await db.delete('files', id);
    }
    selectedFiles.clear();
    renderAllFiles();
    renderDocsFiles();
    renderImagesFiles();
    renderLockList();
    renderCategories();
    showNotif('Selected files deleted.');
};
function getFileExtension(name) {
    const parts = name.split('.');
    return parts.length > 1 ? parts.pop() : '';
}
function getCategoryLabel(key) {
    const cat = CATEGORIES.find(c=>c.key===key);
    return cat ? cat.label : 'Uncategorized';
}
// --- DRAG & DROP UPLOAD (all panels) ---
['uploadDocsArea','uploadImagesArea','panel-allfiles'].forEach(id => {
    const area = document.getElementById(id);
    if (!area) return;
    area.ondragover = e => { e.preventDefault(); area.style.background='#eaf2ff'; };
    area.ondragleave = e => { e.preventDefault(); area.style.background=''; };
    area.ondrop = e => {
        e.preventDefault(); area.style.background='';
        if (e.dataTransfer.files.length) handleFilesUpload(e.dataTransfer.files, id.includes('Docs') ? 'document' : id.includes('Images') ? 'image' : null);
    };
});
function handleFilesUpload(files, type) {
    for (const file of files) {
        if (file.size > 10*1024*1024) {
            showNotif('File too large (max 10MB): ' + file.name, 'error');
            continue;
        }
        pendingFile = [file];
        pendingType = type || (file.type.startsWith('image/') ? 'image' : 'document');
        showPasswordModal();
    }
}
// --- FILE UPLOAD BUTTONS ---
document.getElementById('docsBrowseBtn').onclick = () => document.getElementById('docsInput').click();
document.getElementById('docsInput').onchange = (e) => handleFilesUpload(e.target.files, 'document');
document.getElementById('imagesBrowseBtn').onclick = () => document.getElementById('imagesInput').click();
document.getElementById('imagesInput').onchange = (e) => handleFilesUpload(e.target.files, 'image');
// --- ACCESSIBILITY ---
document.querySelectorAll('.vault-btn').forEach(btn => {
    btn.tabIndex = 0;
    btn.onkeyup = e => { if (e.key==='Enter' || e.key===' ') btn.click(); };
});

// Helper functions
function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

window.viewFile = async function(id) {
    const file = await db.get('files', id);
    if (file.password) {
        const pwd = prompt('Enter password to view this file:');
        if (pwd !== file.password) {
            showNotif('Incorrect password!', 'error');
            return;
        }
    }
    
    // Open file in new tab
    const a = document.createElement('a');
    a.href = file.data;
    a.target = '_blank';
    a.click();
};

window.downloadFile = async function(id) {
    const file = await db.get('files', id);
    if (file.password) {
        const pwd = prompt('Enter password to download this file:');
        if (pwd !== file.password) {
            showNotif('Incorrect password!', 'error');
            return;
        }
    }
    
    const a = document.createElement('a');
    a.href = file.data;
    a.download = file.name;
    a.click();
};

window.deleteFile = async function(id) {
    const file = await db.get('files', id);
    if (file.password) {
        const pwd = prompt('Enter password to delete this file:');
        if (pwd !== file.password) {
            showNotif('Incorrect password!', 'error');
            return;
        }
    }
    
    if (!confirm('Are you sure you want to delete this file?')) return;
    
    await db.delete('files', id);
    renderDocsFiles();
    renderImagesFiles();
    renderLockList();
    renderCategories();
    renderAllFiles();
    showNotif('File deleted.');
};

// Notification handler
function showNotif(message, type = 'success') {
    const notif = document.getElementById('notif');
    notif.textContent = message;
    notif.style.background = type === 'error' ? '#c00' : '#1976d2';
    notif.style.display = 'block';
    setTimeout(() => {
        notif.style.opacity = '0';
        setTimeout(() => {
            notif.style.display = 'none';
            notif.style.opacity = '0.97';
        }, 500);
    }, 3000);
}

// --- CATEGORY MANAGEMENT ---
async function renderCategories() {
    // Render category grid
    const catGrid = document.getElementById('categoryGrid');
    catGrid.innerHTML = '';
    
    // Get file counts per category
    const files = await db.getAll('files');
    const catCounts = {};
    CATEGORIES.forEach(cat => {
        if (!cat.addNew) catCounts[cat.key] = files.filter(f => f.category === cat.key).length;
    });
    
    // Add category cards
    CATEGORIES.forEach(cat => {
        const card = document.createElement('div');
        card.className = cat.addNew ? 'category-card add-new' : 'category-card';
        if (currentCategory === cat.key) card.classList.add('selected');
        
        card.innerHTML = `
            <div class="category-icon"><i class="fas ${cat.icon}"></i></div>
            <div class="category-info">
                <div class="category-name">${cat.label}</div>
            </div>
            ${!cat.addNew ? `<span class="category-count">${catCounts[cat.key] || 0}</span>` : ''}
            ${!cat.addNew ? `<div class="category-actions">
                <button title="Upload" onclick="event.stopPropagation(); showCategoryUploadModal('${cat.key}', '${cat.label}')"><i class="fas fa-upload"></i></button>
            </div>` : ''}
        `;
        
        card.onclick = () => {
            if (cat.addNew) {
                const newCatName = prompt('Enter new category name:');
                if (!newCatName || !newCatName.trim()) return;
                
                const newCatKey = newCatName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const exists = CATEGORIES.some(c => c.key === newCatKey);
                if (exists) {
                    showNotif('Category already exists!', 'error');
                    return;
                }
                
                // Add new category
                CATEGORIES.splice(CATEGORIES.length-1, 0, {
                    key: newCatKey,
                    label: newCatName.trim(),
                    icon: 'fa-folder'
                });
                
                renderCategories();
                return;
            }
            
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            currentCategory = cat.key;
            renderCategoryFiles(cat.key);
        };
        
        catGrid.appendChild(card);
    });
    
    // If no category selected yet, don't show files
    if (!currentCategory) {
        document.getElementById('categoryFileList').innerHTML = '<div class="empty-state"><i class="fas fa-folder"></i><br>Select a category to view files</div>';
    } else {
        renderCategoryFiles(currentCategory);
    }
}

// --- ALL FILES PANEL ---
async function renderAllFiles() {
    const files = await db.getAll('files');
    let filtered = files;
    
    // Apply type filter if set
    if (allFilesType === 'document') {
        filtered = filtered.filter(f => f.fileType === 'document');
    } else if (allFilesType === 'image') {
        filtered = filtered.filter(f => f.fileType === 'image');
    }
    
    // Apply search filter
    filtered = filterFiles(filtered, document.getElementById('allFilesSearch').value);
    
    // Apply sort
    filtered = sortFiles(filtered, document.getElementById('allFilesSort').value);
    
    // Render file list with selection capability
    const list = document.getElementById('allFilesList');
    
    if (!filtered.length) {
        list.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><br>No files found.</div>';
        return;
    }
    
    const filterBar = document.createElement('div');
    filterBar.style.display = 'flex';
    filterBar.style.gap = '10px';
    filterBar.style.marginBottom = '18px';
    filterBar.innerHTML = `
        <button class="upload-btn" style="padding:7px 18px;font-size:15px;${allFilesType==='all'?'background:#1976d2;color:#fff;':''}" onclick="setAllFilesType('all')">All</button>
        <button class="upload-btn" style="padding:7px 18px;font-size:15px;${allFilesType==='document'?'background:#1976d2;color:#fff;':''}" onclick="setAllFilesType('document')">Documents</button>
        <button class="upload-btn" style="padding:7px 18px;font-size:15px;${allFilesType==='image'?'background:#1976d2;color:#fff;':''}" onclick="setAllFilesType('image')">Images</button>
        <div style="flex:1"></div>
        <button class="upload-btn" style="background:#c00;" onclick="deleteSelectedFiles()">Delete Selected</button>
    `;
    list.innerHTML = '';
    list.appendChild(filterBar);
    
    filtered.forEach(file => {
        const card = document.createElement('div');
        card.className = 'file-card';
        if (selectedFiles.has(file.id)) {
            card.style.borderColor = '#1976d2';
            card.style.backgroundColor = '#f0f8ff';
        }
        
        card.innerHTML = `
            <input type="checkbox" style="margin-right:10px" ${selectedFiles.has(file.id) ? 'checked' : ''}>
            <div class="file-preview">${getFilePreview(file)}</div>
            <div class="file-info">
                <span class="file-name">${file.name}</span>
                ${file.password ? '<i class="fas fa-lock locked" title="Locked"></i>' : ''}
                ${file.category ? `<span style="background:#e0e0e0;border-radius:50px;padding:2px 8px;font-size:11px;margin-left:8px">${getCategoryLabel(file.category)}</span>` : ''}
                <br>
                <span class="file-meta">${formatSize(file.size)} &middot; ${timeAgo(file.date)}</span>
            </div>
            <div class="file-actions">
                <button title="View" onclick="viewFile(${file.id})"><i class="fas fa-eye"></i></button>
                <button title="Download" onclick="downloadFile(${file.id})"><i class="fas fa-download"></i></button>
                <button title="Share" onclick="showShareModal(${file.id})"><i class="fas fa-share-alt"></i></button>
                <button title="Rename" onclick="renameFile(${file.id})"><i class="fas fa-edit"></i></button>
                <button title="Delete" onclick="deleteFile(${file.id})"><i class="fas fa-trash"></i></button>
            </div>
        `;
        
        const checkbox = card.querySelector('input[type=checkbox]');
        checkbox.onclick = (e) => {
            e.stopPropagation();
            if (checkbox.checked) {
                selectedFiles.add(file.id);
                card.style.borderColor = '#1976d2';
                card.style.backgroundColor = '#f0f8ff';
            } else {
                selectedFiles.delete(file.id);
                card.style.borderColor = '#e0e0e0';
                card.style.backgroundColor = '#fff';
            }
        };
        
        list.appendChild(card);
    });
}

window.setAllFilesType = function(type) {
    allFilesType = type;
    renderAllFiles();
};

// --- LOCK LIST PANEL ---
async function renderLockList() {
    const files = await db.getAll('files');
    const lockedFiles = files.filter(f => f.password);
    const list = document.getElementById('lockList');
    
    if (!lockedFiles.length) {
        list.innerHTML = '<div class="empty-state"><i class="fas fa-unlock"></i><br>No locked files found.</div>';
        return;
    }
    
    list.innerHTML = '<h3>Password Protected Files</h3>';
    
    lockedFiles.forEach(file => {
        const row = document.createElement('div');
        row.className = 'lock-row';
        row.innerHTML = `
            <div class="file-preview" style="margin-right:10px">${getFilePreview(file)}</div>
            <div style="flex:1">
                <div class="file-name">${file.name}</div>
                <div class="file-meta">${formatSize(file.size)} &middot; ${timeAgo(file.date)}</div>
            </div>
            <input type="password" value="••••••" readonly>
            <button onclick="unlockFile(${file.id})">Unlock</button>
        `;
        list.appendChild(row);
    });
}

window.unlockFile = async function(id) {
    const file = await db.get('files', id);
    const pwd = prompt('Enter current password:');
    if (pwd !== file.password) {
        showNotif('Incorrect password!', 'error');
        return;
    }
    
    if (confirm('Remove password protection?')) {
        file.password = null;
        await db.put('files', file);
        renderLockList();
        renderDocsFiles();
        renderImagesFiles();
        renderCategories();
        renderAllFiles();
        showNotif('File unlocked successfully.');
    }
};

// --- FILE URL HANDLING ---
function checkUrlForFile() {
    if (location.hash && location.hash.startsWith('#file-')) {
        const fileId = parseInt(location.hash.replace('#file-', ''));
        if (!isNaN(fileId)) {
            db.get('files', fileId).then(file => {
                if (file) {
                    viewFile(fileId);
                }
            });
        }
    }
}

// --- CATEGORY ASSIGNMENT ---
window.assignCategory = async function(fileId, catKey) {
    const file = await db.get('files', fileId);
    file.category = catKey;
    await db.put('files', file);
    renderCategories();
    renderDocsFiles();
    renderImagesFiles();
    renderAllFiles();
    showNotif('Category assigned.');
};

// Show category modal for assignment
let pendingFileForCategory = null;

window.showCategoryModal = function(fileId) {
    pendingFileForCategory = fileId;
    const modalGrid = document.getElementById('categoryModalGrid');
    modalGrid.innerHTML = '';
    
    CATEGORIES.forEach(cat => {
        if (cat.addNew) return; // Skip "Add New" category
        
        const btn = document.createElement('button');
        btn.className = 'category-card';
        btn.style.border = '1px solid #ddd';
        btn.style.padding = '10px';
        btn.style.display = 'flex';
        btn.style.alignItems = 'center';
        btn.style.gap = '10px';
        
        btn.innerHTML = `
            <div class="category-icon" style="width:30px;height:30px"><i class="fas ${cat.icon}"></i></div>
            <div>${cat.label}</div>
        `;
        
        btn.onclick = () => {
            assignCategory(pendingFileForCategory, cat.key);
            document.getElementById('categoryModal').classList.remove('active');
        };
        
        modalGrid.appendChild(btn);
    });
    
    document.getElementById('categoryModal').classList.add('active');
};

// Close category modal
document.getElementById('categoryModalClose').onclick = function() {
    pendingFileForCategory = null;
    document.getElementById('categoryModal').classList.remove('active');
};
document.getElementById('categoryModalCancel').onclick = function() {
    pendingFileForCategory = null;
    document.getElementById('categoryModal').classList.remove('active');
};

// --- CATEGORY UPLOAD MODAL ---
window.showCategoryUploadModal = function(categoryKey, categoryLabel) {
    pendingCategory = categoryKey;
    document.getElementById('catUploadName').textContent = categoryLabel;
    document.getElementById('categoryUploadModal').classList.add('active');
    
    // Set up upload functionality
    setupCategoryUpload();
};

function setupCategoryUpload() {
    const browseBtn = document.getElementById('catUploadBrowseBtn');
    const fileInput = document.getElementById('catUploadInput');
    const uploadArea = document.getElementById('catUploadArea');
    
    // Clear any previous event listeners
    const newFileInput = fileInput.cloneNode(true);
    fileInput.parentNode.replaceChild(newFileInput, fileInput);
    
    // Set up new event listeners
    browseBtn.onclick = () => newFileInput.click();
    
    newFileInput.onchange = (e) => {
        if (e.target.files.length) {
            pendingFile = Array.from(e.target.files);
            pendingType = determineFileTypes(pendingFile);
            document.getElementById('categoryUploadModal').classList.remove('active');
            showPasswordModal();
        }
    };
    
    // Drag and drop setup
    uploadArea.ondragover = e => { e.preventDefault(); uploadArea.style.background='#eaf2ff'; };
    uploadArea.ondragleave = e => { e.preventDefault(); uploadArea.style.background=''; };
    uploadArea.ondrop = e => {
        e.preventDefault(); uploadArea.style.background='';
        if (e.dataTransfer.files.length) {
            pendingFile = Array.from(e.dataTransfer.files);
            pendingType = determineFileTypes(pendingFile);
            document.getElementById('categoryUploadModal').classList.remove('active');
            showPasswordModal();
        }
    };
}

function determineFileTypes(files) {
    // Determine if all files are images or documents or mixed
    const isAllImages = files.every(file => file.type.startsWith('image/'));
    const isAllDocs = files.every(file => 
        file.type === 'application/pdf' || 
        file.type.includes('word') || 
        file.type.includes('doc') ||
        file.name.endsWith('.pdf') || 
        file.name.endsWith('.doc') || 
        file.name.endsWith('.docx')
    );
    
    return isAllImages ? 'image' : isAllDocs ? 'document' : 'mixed';
}

// Close category upload modal
document.getElementById('catUploadModalClose').onclick = function() {
    pendingCategory = null;
    document.getElementById('categoryUploadModal').classList.remove('active');
};

document.getElementById('catUploadCancel').onclick = function() {
    pendingCategory = null;
    document.getElementById('categoryUploadModal').classList.remove('active');
};

// --- SHARE FEATURE ---
window.showShareModal = async function(fileId) {
    // Get file details
    const file = await db.get('files', fileId);
    if (!file) {
        showNotif('File not found', 'error');
        return;
    }
    
    pendingShareFile = file;
    
    // Reset share form
    document.getElementById('shareExpiry').value = '7';
    document.getElementById('sharePassword').value = '';
    document.getElementById('shareLinkResult').style.display = 'none';
    document.getElementById('copyShareLinkBtn').style.display = 'none';
    
    // Display file name
    document.getElementById('shareFileName').textContent = file.name;
    
    // Check for existing shares
    const tx = db.transaction('shares', 'readonly');
    const shareStore = tx.objectStore('shares');
    const fileShares = await shareStore.index('fileId').getAll(fileId);
    
    const activeShares = fileShares.filter(share => {
        return share.expiresAt === 0 || new Date(share.expiresAt) > new Date();
    });
    
    // Display active shares if any
    const shareHistorySection = document.getElementById('shareHistory');
    const activeSharesList = document.getElementById('activeSharesList');
    
    if (activeShares.length > 0) {
        shareHistorySection.style.display = 'block';
        activeSharesList.innerHTML = '';
        
        activeShares.forEach(share => {
            const shareItem = document.createElement('div');
            shareItem.className = 'share-item';
            
            const expiryText = share.expiresAt === 0 
                ? 'Never expires' 
                : `Expires on ${new Date(share.expiresAt).toLocaleDateString()}`;
                
            shareItem.innerHTML = `
                <div class="share-item-info">
                    <div class="active-share">
                        <i class="fas fa-link"></i> Active share
                        ${share.password ? ' <i class="fas fa-lock" title="Password protected"></i>' : ''}
                    </div>
                    <div class="share-item-expires">${expiryText}</div>
                    <div style="font-size:13px;color:#555;margin-top:4px">
                        Created on ${new Date(share.createdAt).toLocaleDateString()}
                    </div>
                </div>
                <div class="share-item-actions">
                    <button onclick="copyShareLinkById('${share.shareId}')">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button style="background:#c00" onclick="revokeShare('${share.shareId}')">
                        <i class="fas fa-trash"></i> Revoke
                    </button>
                </div>
            `;
            
            activeSharesList.appendChild(shareItem);
        });
    } else {
        shareHistorySection.style.display = 'none';
    }
    
    // Show modal
    document.getElementById('shareModal').classList.add('active');
};

// Generate share link
document.getElementById('generateShareLink').onclick = async function() {
    if (!pendingShareFile) return;
    
    const expiryDays = parseInt(document.getElementById('shareExpiry').value);
    const sharePassword = document.getElementById('sharePassword').value;
    
    // Calculate expiry date
    const expiresAt = expiryDays === 0 ? 0 : Date.now() + (expiryDays * 24 * 60 * 60 * 1000);
    
    // Generate share ID - use a secure random ID
    const shareId = Array.from(crypto.getRandomValues(new Uint8Array(16)))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
        
    // Create share object
    const shareObj = {
        shareId,
        fileId: pendingShareFile.id,
        fileName: pendingShareFile.name,
        fileType: pendingShareFile.type,
        createdAt: Date.now(),
        expiresAt,
        password: sharePassword || null,
        accessCount: 0
    };
    
    // Store in database
    await db.add('shares', shareObj);
    
    // Generate full share link
    const shareLink = `${location.origin}${location.pathname}#share-${shareId}`;
    
    // Display link
    const shareLinkResult = document.getElementById('shareLinkResult');
    shareLinkResult.textContent = shareLink;
    shareLinkResult.style.display = 'block';
    
    // Show copy button
    document.getElementById('copyShareLinkBtn').style.display = 'inline-block';
    
    // Update active shares list
    await showShareModal(pendingShareFile.id);
    
    showNotif('Share link generated successfully');
};

// Copy share link
document.getElementById('copyShareLinkBtn').onclick = async function() {
    const linkText = document.getElementById('shareLinkResult').textContent;
    try {
        await navigator.clipboard.writeText(linkText);
        showNotif('Share link copied to clipboard');
    } catch (err) {
        console.error('Failed to copy:', err);
        showNotif('Failed to copy to clipboard', 'error');
    }
};

// Copy share link by ID
window.copyShareLinkById = async function(shareId) {
    const shareLink = `${location.origin}${location.pathname}#share-${shareId}`;
    try {
        await navigator.clipboard.writeText(shareLink);
        showNotif('Share link copied to clipboard');
    } catch (err) {
        showNotif('Failed to copy to clipboard', 'error');
    }
};

// Revoke share
window.revokeShare = async function(shareId) {
    if (!confirm('Are you sure you want to revoke this share link? It will no longer be accessible.')) {
        return;
    }
    
    await db.delete('shares', shareId);
    if (pendingShareFile) {
        await showShareModal(pendingShareFile.id);
    }
    showNotif('Share link has been revoked');
};

// Close share modal
document.getElementById('shareModalClose').onclick = function() {
    pendingShareFile = null;
    document.getElementById('shareModal').classList.remove('active');
};
document.getElementById('shareModalCancel').onclick = function() {
    pendingShareFile = null;
    document.getElementById('shareModal').classList.remove('active');
};

// --- SHARE ACCESS HANDLING ---
let pendingShareAccess = null;

// Process hash for shares
async function checkUrlForShare() {
    if (location.hash && location.hash.startsWith('#share-')) {
        const shareId = location.hash.replace('#share-', '');
        
        try {
            const share = await db.get('shares', shareId);
            
            if (!share) {
                showNotif('This share link is invalid or has been revoked', 'error');
                return;
            }
            
            // Check if expired
            if (share.expiresAt !== 0 && new Date(share.expiresAt) < new Date()) {
                showNotif('This share link has expired', 'error');
                return;
            }
            
            pendingShareAccess = share;
            
            // Show access modal
            const fileInfo = document.getElementById('sharedFileInfo');
            fileInfo.innerHTML = `<strong>${share.fileName}</strong><br>
                <span style="color:#555">Shared file (${share.fileType.split('/')[1] || share.fileType})</span>`;
            
            // Show password prompt if needed
            const passwordPrompt = document.getElementById('sharePasswordPrompt');
            if (share.password) {
                passwordPrompt.style.display = 'block';
                document.getElementById('accessSharePassword').value = '';
            } else {
                passwordPrompt.style.display = 'none';
            }
            
            document.getElementById('shareAccessModal').classList.add('active');
            
        } catch (err) {
            console.error('Error processing share:', err);
            showNotif('Error processing share link', 'error');
        }
    }
}

// Access shared file
document.getElementById('shareAccessConfirm').onclick = async function() {
    if (!pendingShareAccess) return;
    
    // Check password if needed
    if (pendingShareAccess.password) {
        const enteredPassword = document.getElementById('accessSharePassword').value;
        if (enteredPassword !== pendingShareAccess.password) {
            showNotif('Incorrect password', 'error');
            return;
        }
    }
    
    try {
        // Get the file
        const file = await db.get('files', pendingShareAccess.fileId);
        if (!file) {
            showNotif('The shared file is no longer available', 'error');
            document.getElementById('shareAccessModal').classList.remove('active');
            return;
        }
        
        // Update access count
        pendingShareAccess.accessCount += 1;
        pendingShareAccess.lastAccessed = Date.now();
        await db.put('shares', pendingShareAccess);
        
        // Close modal
        document.getElementById('shareAccessModal').classList.remove('active');
        
        // Open file
        const a = document.createElement('a');
        a.href = file.data;
        a.target = '_blank';
        a.click();
        
    } catch (err) {
        console.error('Error accessing shared file:', err);
        showNotif('Error accessing the shared file', 'error');
    }
};

// Close share access modal
document.getElementById('shareAccessModalClose').onclick = function() {
    pendingShareAccess = null;
    document.getElementById('shareAccessModal').classList.remove('active');
};
document.getElementById('shareAccessCancel').onclick = function() {
    pendingShareAccess = null;
    document.getElementById('shareAccessModal').classList.remove('active');
};

// -- APP INITIALIZATION --
window.addEventListener('DOMContentLoaded', async function() {
    try {
        await initDB();
        setupUploadDocs();
        setupUploadImages();
        renderDocsFiles();
        checkUrlForFile();
        checkUrlForShare(); // Check for share links
        
        // Add event listener for hash changes (for file links and share links)
        window.addEventListener('hashchange', function() {
            checkUrlForFile();
            checkUrlForShare();
        });
        
        // Add search listeners
        document.getElementById('allFilesSearch').addEventListener('input', renderAllFiles);
        document.getElementById('allFilesSort').addEventListener('change', renderAllFiles);
        
        // Periodically clean expired shares
        setInterval(async function() {
            const tx = db.transaction('shares', 'readwrite');
            const shareStore = tx.objectStore('shares');
            const expiredShares = await shareStore.index('expiresAt').getAll(IDBKeyRange.upperBound(Date.now()));
            
            for (const share of expiredShares) {
                if (share.expiresAt !== 0) { // Skip never-expiring links
                    await shareStore.delete(share.shareId);
                }
            }
        }, 60 * 60 * 1000); // Check once per hour
        
    } catch (err) {
        console.error('Failed to initialize Report Vault:', err);
        alert('Failed to initialize Report Vault. Please make sure your browser supports IndexedDB.');
    }
});
</script>
</body>
</html> 